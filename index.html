<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agente prueba CHATWOOT</title>

  <link href="https://cdn.jsdelivr.net/npm/@n8n/chat/dist/style.css" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .chat-container { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 500px; height: 600px; display: flex; flex-direction: column; overflow: hidden; }
    .chat-header { background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); color: white; padding: 20px; text-align: center; }
    .chat-header h3 { font-size: 1.2em; font-weight: 600; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #F7F7F7; }
    .message { margin-bottom: 15px; animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-content { padding: 12px 16px; border-radius: 18px; max-width: 80%; word-wrap: break-word; }
    .user-message .message-content { background: #667EEA; color: white; margin-left: auto; border-bottom-right-radius: 4px; }
    .bot-message .message-content { background: white; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .chat-input-container { padding: 20px; background: white; border-top: 1px solid #E0E0E0; }
    .input-wrapper { display: flex; gap: 10px; }
    #messageInput { flex: 1; padding: 12px 16px; border: 2px solid #E0E0E0; border-radius: 24px; font-size: 14px; outline: none; transition: border-color 0.3s; }
    #messageInput:focus { border-color: #667EEA; }
    #sendButton { background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%); border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; color: white; }
    #sendButton:hover { transform: scale(1.05); }
    #sendButton:active { transform: scale(0.95); }
    #sendButton:disabled { opacity: 0.5; cursor: not-allowed; }
    .chatwoot-iframe, .chatwoot-launcher { z-index: 99999; }
  </style>
</head>
<body>
  <main class="chat-container" aria-label="Chat widget">
    <header class="chat-header">
      <h3>Agente de Prueba — Chat</h3>
    </header>

    <section id="localMessages" class="chat-messages" aria-live="polite"></section>

    <div class="chat-input-container">
      <div class="input-wrapper">
        <input id="messageInput" type="text" placeholder="Escribí tu mensaje..." aria-label="Mensaje" />
        <button id="sendButton" aria-label="Enviar mensaje">➤</button>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const input = document.getElementById('messageInput');
      const send = document.getElementById('sendButton');
      const localMessages = document.getElementById('localMessages');

      function pushLocal(text, cls='user-message') {
        const wrap = document.createElement('div');
        wrap.className = 'message ' + cls;
        const inner = document.createElement('div');
        inner.className = 'message-content';
        inner.textContent = text;
        wrap.appendChild(inner);
        localMessages.appendChild(wrap);
        localMessages.scrollTop = localMessages.scrollHeight;
      }

      // UI-only: muestra el mensaje localmente (no lo manda a n8n)
      send.addEventListener('click', () => {
        const text = input.value.trim();
        if (!text) return;
        pushLocal(text, 'user-message');
        input.value = '';
        input.focus();
        setTimeout(() => pushLocal('Este demo sólo muestra el mensaje localmente. Usa el launcher flotante (abajo) para hablar via Chatwoot.', 'bot-message'), 400);
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') send.click();
      });
    })();
  </script>

  <!-- Chatwoot widget -->
  <script>
    (function(d,t) {
      // tus datos:
      var BASE_URL = "http://31.97.243.241:3000"; // tu base_url
      var WEBSITE_TOKEN = "hsngErdhDU26QUUR2KQED9zE"; // tu websiteToken
      var IDENTITY_TOKEN = "FmxD7X6fBb94UC5fCsKLbFdb"; // token de validación opcional (ver nota)

      var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
      g.src = BASE_URL + "/packs/js/sdk.js";
      g.async = true;
      s.parentNode.insertBefore(g, s);

      g.onload = function () {
        if (!window.chatwootSDK) {
          console.warn('Chatwoot SDK no disponible. Revisa BASE_URL y que el servidor Chatwoot esté alcanzable.');
          return;
        }

        window.chatwootSDK.run({
          websiteToken: WEBSITE_TOKEN,
          baseUrl: BASE_URL
        });

        // ---- Opcional: identificar visitante ----
        // Dependiendo de la versión de tu Chatwoot (self-hosted), puedes:
        // 1) Usar setUserToken (si generaste un token de identidad server-side).
        // 2) O setUser / setUserAttributes si tu SDK lo soporta.
        //
        // Prueba esto si querés que el widget abra la conversación ya identificada.
        try {
          // Opción A: si tu versión soporta setUserToken (HMAC/identity token)
          if (window.chatwootSDK.setUserToken) {
            window.chatwootSDK.setUserToken(IDENTITY_TOKEN);
            // después de esto el visitante queda identificado en Chatwoot (si el token es correcto)
          }
          // Opción B: si tu versión soporta setUser (fallback)
          else if (window.chatwootSDK.setUser) {
            // ejemplo: identifica por email / nombre (ajustalo según la info que tengas)
            window.chatwootSDK.setUser('demo.user@example.com', { name: 'Usuario Demo' });
          }
        } catch (err) {
          console.warn('No se pudo ejecutar la identificación automática del visitante:', err);
        }
      };
    })(document,"script");
  </script>

  <!-- fin -->
</body>
</html>
